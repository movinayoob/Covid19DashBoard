<!DOCTYPE html>
<html lang="en">
  <script src="https://d3js.org/d3.v7.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <script src="./assets/dataLoad.js"></script>
  <!-- <script src="./assets/Exercises/Lab3/dataFiltering.js"></script> -->
  <head>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,700"
    />
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="./assets/dashboardIcon.png"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="./assets/main.css" />
    <title>CW - CourseWork1</title>
  </head>

  <body class="body_main" style="background-image: None; background-color: #2c3949">
    <nav class="nav">
      <ul class="nav__list">
        <li class="nav__listlogo">
          <a href="https://www.hw.ac.uk/dubai/" target="_blank"
            ><img src="././assets/Heriot_Watt_Logo.png" alt="heriottwatt_logo"
          /></a>
        </li>
        <a href="./index_home.html"><li class="nav__listitem">Home</li></a>
       
        <li class="nav__listitem">
          Links
          <ul class="nav__listitemdrop">
            <a href="https://github.com/mzashin/HW_F21DV" target="_blank"
              ><li>
                <i style="font-size: 18px" class="fa">&#xf09b;</i> GitHub
              </li></a
            >
          </ul>
        </li>
        <a href="./student_info.html"
          ><li class="nav__listitem">Student Info</li></a>
      </ul>
    </nav>

    <div class="graph-container">
      <!-- <div class="exercise_card_container" id="lab2_header"> -->
        <div class="title_container" style="background-color: white">
          <div class="dashboard_title" style="color: #0b4183">
            CourseWork 1 - Covid - 19 Dashboard
          </div>
        </div>
      <!-- </div> -->
    </div>
    <div class="graph-container">
      <div>
        <span id="map"></span>
      </div>
      <div>
        <span id="line_chart"></span>
      </div>
    </div>

<script>
   function createMap(csv_loc, property, element_Id) {
      const width = 800;
      const height = 650;
      const svg = d3
        .select("#" + element_Id)
        .append("svg")
        .style("background-color", "white")
        .attr("width", width)
        .attr("height", height)
        .attr("x", 0)
        .attr("y", 0);

      const Tooltip = d3
        .select("#" + element_Id)
        .append("span")
        .style("opacity", 0)
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "2px")
        .style("border-radius", "5px")
        .style("padding", "5px")
        .style("position", "absolute");
      svg
        .style("border", "solid")
        .style("border-width", "5px")
        .style("border-radius", "10px")
        .style("padding", "5px")
        .style("border-color", "white");

      svg
        .append("rect")
        .attr("width", width)
        .attr("height", 20)
        .attr("x", 0)
        .attr("y", 0)
        .attr("fill", "white");

      svg
        .append("text")
        .attr("class", "map_chart_title")
        .attr("x", width / 2 - 100)
        .attr("y", 15)
        .style("fill", "red")
        .text("New Cases");

      svg
        .append("rect")
        .attr("width", 400)
        .attr("height", 20)
        .attr("x", width / 2 - 200)
        .attr("y", 25)
        .attr("fill", "white");

      svg
        .append("text")
        .attr("class", "map_evol_action_title")
        .attr("x", width / 2 - 160)
        .attr("y", 40)
        .style("fill", "red")
        .text("**Click on Country");
      // Map and projection
      const path = d3.geoPath();
      const projection = d3
      . geoNaturalEarth1()
        .scale(140)
        .center([0, 20])
        .translate([width / 2, height / 2]);

      // Data and color scale
      const data = new Map();
      var colorScale = d3
        .scaleLinear()
        .domain([100000, 1000000, 10000000, 30000000, 100000000, 500000000])
        .range(["green", "pink", "red"]);

        fetch_total_by_iso(csv_loc, property).then(function (d) {
        console.log("d", d);
        d.forEach(function (d) {
          data.set(d.key, d.value);
        });

        console.log("map", data);
        // Load external data and boot
        Promise.all([
          d3.json(
           "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"
          ),
        ]).then(function (loadData) {
          let topo = loadData[0];
          console.log("data", data);
          let mouseOver = function (d) {
            d3.selectAll(".Country")
              .transition()
              .duration(200)
              .style("opacity", 0.5)
              .style("stroke", "transparent");

            Tooltip.style("opacity", 1);

            d3.select(this)
              .transition()
              .duration(200)
              .style("opacity", 1)
              .style("stroke", "black");
          };

          const mousemove = function (event, d) {
            //d.total = data.get(d.id) || 0;
            Tooltip.html(
              "<u>" +
                d.properties.name +
                "</u> : <u>" +
                d.total +
                "</u>"
            )
              .style("left", event.pageX - 50 + "px")
              //.style("left", 0 + "px")
              .style("top", event.pageY - 200 + "px");
          };

          var clickfunction = function (event, d) {
            console.log("d", d);
            console.log("event", event);
            location_sel = d.properties.name;
            console.log("location_sel", location_sel);
            property = "total_cases";

            csv_loc =
                "https://raw.githubusercontent.com/mzashin/HW_F21DV/main/CourseProject/assets/Exercises/Lab3/dataset/owid-covid-data.csv"
            createSingleLineChart(csv_loc,  location_sel,property);
          };
          let mouseLeave = function (d) {
            d3.selectAll(".Country")
              .transition()
              .duration(200)
              .style("opacity", 0.8);
            d3.select(this)
              .transition()
              .duration(200)
              .style("stroke", "transparent");

            Tooltip.style("opacity", 0);
          };

          // Draw the map
          svg
            .append("g")
            .selectAll("path")
            .data(topo.features)
            .enter()
            .append("path")
            // draw each country
            .attr("d", d3.geoPath().projection(projection))
            // set the color of each country
            .attr("fill", function (d) {
              d.total = data.get(d.id) || 0;
              console.log("d.id", d.id, " d.total", d.total);
              return colorScale(d.total);
            })
            .attr("fill-opacity", "0.7")
            .style("stroke", "transparent")
            .attr("class", function (d) {
              return "Country";
            })
            .style("opacity", 0.8)
            .on("mouseover", mouseOver)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseLeave)
            .on("click", clickfunction);
        });
      });
    }
    csv_loc =
      "https://raw.githubusercontent.com/mzashin/HW_F21DV/main/CourseProject/assets/Exercises/Lab3/dataset/owid-covid-data.csv";
    property = "new_cases";
    element_Id = "map";
    createMap(csv_loc, property, element_Id);

    ////////////////////////MAP CREATED///


     ////////////////////////START SINGLE LINE CHART///

    function createSingleLineChart(csv_path, country, property) {
        debugger;
        const margin = { top: 30, right: 30, bottom: 70, left: 60 };
        const width = 1400 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3
         .select("#line_chart")
          .html("")
          .append("div")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .style("background-color", "white")
          .style("border", "solid")
          .style("border-width", "5px")
          .style("border-radius", "10px")
          .style("padding", "5px")
          .style("border-color", "white")
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          );

        svg
          .append("rect")
          .attr("width", 580)
          .attr("height", 20)
          .attr("x", 10)
          .attr("y", -25)
          .attr("fill", "white");

        // X axis
        var x = d3.scaleTime().range([0, width]);
        var x_axis = svg
          .append("g")
          .attr("transform", "translate(0," + height + ")");
        // Add Y axis
        var y = d3.scaleLinear().range([height, 0]);
        var y_axis = svg.append("g").attr("class", "myYaxis");

        // A function that create / update the plot for a given variable:
        //function update(data, color_name) {

        color_name = "red";
        var format = d3.timeFormat("%Y-%m-%d");

        filterDataBySingleProperty(csv_loc, country, property).then(function (data) {
          svg
            .append("text")
            .attr("x", 200)
            .attr("y", -10)
            .style("fill", "red")
            .text(country + " : " + property + " per day");

          x.domain(
            d3.extent(data, function (d) {
              return d.date;
            })
          );
          //x.domain(
          //  data.map(function (d) {
          //    return d.date;
          //  })
          //);
          y.domain([
            0,
            d3.max(data, function (d) {
              return d.value;
            }),
          ]);
          x_axis
            .call(
              d3.axisBottom(x).ticks(20).tickFormat(d3.timeFormat("%Y-%m-%d"))
              //.tickValues(
              //  data.map(function (d) {
              //    return new Date(d.date);
              //  })
              //)
            )
            .selectAll("text")
            .style("text-anchor", "end")
            .style("color", "black")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-65)");
          y_axis.transition().duration(1000).call(d3.axisLeft(y));

          var u = svg.selectAll(".line").data([data], (d) => {
            return d.date;
          });

          u.enter()
            .append("path")
            .attr("class", "line")
            .merge(u)
            .transition()
            .duration(1000)
            .attr(
              "d",
              d3
                .line()
                .x(function (d) {
                  return x(d.date);
                })
                .y(function (d) {
                  return y(d.value);
                })
            )
            .attr("fill", "none")
            .attr("stroke", color_name)
            .attr("stroke-width", 3);
        });
      }
       ////////////////////////START SINGLE LINE CHART CREATED///
       csv_path =
        "https://raw.githubusercontent.com/mzashin/HW_F21DV/main/CourseProject/assets/Exercises/Lab3/dataset/owid-covid-data.csv";
        location_selected = "United Arab Emirates";
      property = "total_cases";

      createSingleLineChart(csv_path, location_selected,property);
</script>

  </body>
</html>
